package com.rockjobs.core.usuario;import com.rockjobs.Dados;import com.rockjobs.core.pesquisa_base_old.RequestPesquisa;import com.rockjobs.core.queryMapper.QueryMapper;import com.rockjobs.core.security.service.Logado;import com.rockjobs.core.usuario.dto.UsuarioPesquisaDTO;import com.rockjobs.core.util.Regex;import com.rockjobs.core.util.StringUtil;import com.ordnaelmedeiros.jpafluidselect.querybuilder.select.pagination.PaginationResult;import org.hibernate.Session;import javax.enterprise.context.RequestScoped;import javax.inject.Inject;import javax.persistence.EntityManager;import javax.persistence.Query;import java.util.List;@RequestScopedpublic class UsuarioPesquisaService {    @Inject    EntityManager em;    @Inject    Logado logado;    private static final String SQL =            "select " +            "<<campos>>" +            " from " +            "usuario t " +            "<<joins>> " +            "where (true) ";    private static final String CAMPOS_PESQUISA =            "t.id," +            "t.nome || ' - ' || t.sobrenome \"nome\"," +            "t.email," +            "t.cpf," +            "t.endereco," +            "t.telefone_celular," +            "t.ativo ";    private static final String JOINS = "";    public PaginationResult<UsuarioPesquisaDTO> listar(RequestPesquisa requestPesquisa) throws Exception {        //Faz o count dos registros        var sql = SQL;        sql = adicionaFiltrosPesquisa(requestPesquisa, sql);        sql = sql.replace("<<campos>>", "count(*) ");        sql = sql.replace("<<joins>>", JOINS);        Long count = Long.valueOf(this.em.unwrap(Session.class).createSQLQuery(sql).getSingleResult().toString());        //Busca registros        sql = SQL;        sql = sql.replace("<<campos>>", CAMPOS_PESQUISA);        sql = sql.replace("<<joins>>", JOINS);        sql = adicionaFiltrosPesquisa(requestPesquisa, sql);        sql = sql + " order by id ";        if (requestPesquisa.getPagina() > -1) {            sql = sql + "limit 50 " + (requestPesquisa.getPagina() > 1 ? "offset " + (requestPesquisa.getPagina() - 1) * 50 : "");        }        Query q = this.em.createNativeQuery(sql);        List<UsuarioPesquisaDTO> result = QueryMapper.getListDTO(q, UsuarioPesquisaDTO.class);        return Dados.geraLista(result, requestPesquisa.getPagina(), count);    }    private String adicionaFiltrosPesquisa(RequestPesquisa requestPesquisa, String sql) {        if (!TipoAcesso.ADMIN_GERAL.equals(logado.getUsuario().getTipoAcesso()) && logado.getUsuario().getCliente() != null) {            sql += " and (t.cliente_id = " + logado.getUsuario().getCliente().getId() + ")";        }        if (StringUtil.isNotEmpty(requestPesquisa.getValor())) {            sql = sql + " and (t.nome ilike '%" + requestPesquisa.getValor() + "%' or t.sobrenome ilike '%" + requestPesquisa.getValor() + "%')";        }        if (requestPesquisa.getFiltrosPersonalizados() != null && !requestPesquisa.getFiltrosPersonalizados().isEmpty()) {            if (requestPesquisa.getFiltrosPersonalizados().containsKey("email") && StringUtil.isNotEmpty(requestPesquisa.getFiltrosPersonalizados().get("email"))) {                sql = sql + " and t.email ilike '%" + requestPesquisa.getFiltrosPersonalizados().get("email") + "%'";            }            if (requestPesquisa.getFiltrosPersonalizados().containsKey("nome") && StringUtil.isNotEmpty(requestPesquisa.getFiltrosPersonalizados().get("nome"))) {                sql = sql + " and t.nome ilike '%" + requestPesquisa.getFiltrosPersonalizados().get("nome") + "%'";            }            if (requestPesquisa.getFiltrosPersonalizados().containsKey("cpf") && StringUtil.isNotEmpty(requestPesquisa.getFiltrosPersonalizados().get("cpf"))) {                sql = sql + " and t.cpf ilike '%" + requestPesquisa.getFiltrosPersonalizados().get("cpf").toString().replaceAll(Regex.DIGITO_SEM_MASCARA, "") + "%'";            }            if (requestPesquisa.getFiltrosPersonalizados().containsKey("permissao") && StringUtil.isNotEmpty(requestPesquisa.getFiltrosPersonalizados().get("permissao"))) {                sql = sql + " and t.tipo_acesso = '" + requestPesquisa.getFiltrosPersonalizados().get("permissao").toString() + "'";            }        }        return sql;    }}